<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Formal Sales Receipt - Landscape</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <!-- Firebase Auth Protection -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="trial.js"></script>
    <script>
      // REPLACE WITH YOUR FIREBASE CONFIG
      const firebaseConfig = {
        apiKey: "AIzaSyDnN7AODVubqLmnOniyjQkSWGvBJJ2kMQU",
        authDomain: "invoiceapp-3fe51.firebaseapp.com",
        projectId: "invoiceapp-3fe51",
        storageBucket: "invoiceapp-3fe51.firebasestorage.app",
        messagingSenderId: "178955208220",
        appId: "1:178955208220:web:128a713add6c992f9981d9",
      };

      // Initialize (prevent re-init error if multiple scripts use it, though here it's standalone page)
      if (!firebase.apps.length) {
        firebase.initializeApp(firebaseConfig);
      }

      const auth = firebase.auth();
      const db = firebase.firestore();

      auth.onAuthStateChanged(async (user) => {
        if (!user) {
          // Not logged in -> Redirect to Login
          window.location.href = "login.html";
        } else {
          // Logged in -> Check Subscription
          const userDoc = await db.collection("users").doc(user.uid).get();
          if (userDoc.exists) {
            const data = userDoc.data();
            const now = new Date();

            // Check if expiry date exists and is in the future
            if (
              !data.subscriptionExpiry ||
              data.subscriptionExpiry.toDate() < now
            ) {
              // Expired -> show subscribe modal instead of immediate redirect
              if (window.blockPageWithSubscribe)
                window.blockPageWithSubscribe();
              else window.location.href = "payment.html";
            }
            // Otherwise, access granted.
          } else {
            if (window.blockPageWithSubscribe) window.blockPageWithSubscribe();
            else window.location.href = "payment.html";
          }
        }
      });
    </script>
    <style>
      @import url("https://fonts.googleapis.com/css2?family=Crimson+Pro:ital,wght@0,400;0,700;1,400&family=Inter:wght@400;700&display=swap");

      body {
        font-family: "Inter", sans-serif;
      }

      .formal-font {
        font-family: "Crimson Pro", serif;
      }

      /* Landscape A5 / Receipt Dimensions */
      /* Landscape A5 / Receipt Dimensions */
      #receiptCapture {
        width: 210mm;
        min-height: 148mm;
        background: white;
        padding: 10mm;
        box-sizing: border-box;
        position: relative;
      }

      #innerBorder {
        border: 4px solid #334155;
        padding: 10mm;
        min-height: 128mm;
        /* 148 - 20 padding */
        position: relative;
      }

      .dotted-line {
        border-bottom: 1px dotted #64748b;
        display: inline-block;
        padding-left: 10px;
        font-style: italic;
        color: #1e293b;
      }

      @media (max-width: 900px) {
        #previewScale {
          transform: scale(0.45);
          transform-origin: top left;
        }

        .preview-container {
          height: 400px;
          overflow: auto;
        }
      }
    </style>
  </head>

  <body class="bg-slate-200 p-4 md:p-8">
    <div class="max-w-7xl mx-auto mb-4">
      <a
        href="dashboard.html"
        class="inline-flex items-center gap-2 text-slate-600 hover:text-blue-600 font-bold transition"
      >
        <i class="fa-solid fa-arrow-left"></i> Back to Dashboard
      </a>
    </div>
    <div class="max-w-7xl mx-auto grid grid-cols-1 xl:grid-cols-12 gap-8">
      <div
        class="xl:col-span-4 bg-white p-6 rounded-2xl shadow-xl space-y-6 overflow-y-auto max-h-screen"
      >
        <h2 class="text-xl font-black flex items-center gap-2">
          <i class="fa-solid fa-file-contract text-blue-600"></i> Receipt
          Details
        </h2>

        <div class="space-y-4">
          <h3 class="text-sm font-bold text-slate-500 uppercase border-b pb-1">
            Logo & Business Info
          </h3>
          <div>
            <label class="text-xs font-bold text-slate-400 uppercase"
              >Upload Logo</label
            >
            <input
              type="file"
              accept="image/*"
              onchange="loadLogo(this)"
              class="block w-full text-xs mt-1"
            />
          </div>
          <input
            type="text"
            id="bizName"
            placeholder="Company Name"
            class="w-full p-3 border rounded-xl"
            oninput="update()"
          />
          <textarea
            id="bizInfo"
            placeholder="Address, Email, Phone Numbers"
            class="w-full p-3 border rounded-xl h-20 text-sm"
            oninput="update()"
          ></textarea>

          <h3
            class="text-sm font-bold text-slate-500 uppercase border-b pb-1 mt-6"
          >
            Transaction Info
          </h3>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
            <input
              type="text"
              id="rNo"
              placeholder="Receipt No."
              class="p-3 border rounded-xl"
              oninput="update()"
            />
            <input
              type="date"
              id="rDate"
              class="p-3 border rounded-xl text-slate-500"
              oninput="update()"
            />
            <select
              id="currency"
              class="p-3 border rounded-xl bg-white"
              onchange="update()"
            >
              <option value="$" data-symbol="$" data-name="Dollars">
                USA (USD)
              </option>
              <option value="$" data-symbol="$" data-name="Dollars">
                Canada (CAD)
              </option>
              <option value="£" data-symbol="£" data-name="Pounds">
                UK (GBP)
              </option>
              <option value="€" data-symbol="€" data-name="Euros">
                Europe (EUR)
              </option>
              <option value="₣" data-symbol="₣" data-name="Francs">
                Switzerland (CHF)
              </option>
              <option value="A$" data-symbol="A$" data-name="Dollars">
                Australia (AUD)
              </option>
              <option value="¥" data-symbol="¥" data-name="Yen">
                Japan (JPY)
              </option>
              <option value="¥" data-symbol="¥" data-name="Yuan">
                China (CNY)
              </option>
              <option value="₹" data-symbol="₹" data-name="Rupees">
                India (INR)
              </option>
              <option value="S$" data-symbol="S$" data-name="Dollars">
                Singapore (SGD)
              </option>
              <option value="HK$" data-symbol="HK$" data-name="Dollars">
                Hong Kong (HKD)
              </option>
              <option value="$" data-symbol="$" data-name="Pesos">
                Mexico (MXN)
              </option>
              <option value="R$" data-symbol="R$" data-name="Reais">
                Brazil (BRL)
              </option>
              <option value="₨" data-symbol="₨" data-name="Rupees">
                Pakistan (PKR)
              </option>
              <option value="د.إ" data-symbol="د.إ" data-name="Dirhams">
                UAE (AED)
              </option>
              <option value="฿" data-symbol="฿" data-name="Baht">
                Thailand (THB)
              </option>
              <optgroup label="African Countries">
                <option value="E£" data-symbol="E£" data-name="Pounds">
                  Egypt (EGP)
                </option>
                <option value="GH₵" data-symbol="GH₵" data-name="Ghana Cedis">
                  Ghana (GHS)
                </option>
                <option value="₦" data-symbol="₦" data-name="Naira">
                  Nigeria (NGN)
                </option>
                <option value="R" data-symbol="R" data-name="Rand">
                  South Africa (ZAR)
                </option>
                <option value="Sh" data-symbol="Sh" data-name="Shillings">
                  Kenya (KES)
                </option>
                <option value="Sh" data-symbol="Sh" data-name="Shillings">
                  Tanzania (TZS)
                </option>
                <option value="Sh" data-symbol="Sh" data-name="Shillings">
                  Uganda (UGX)
                </option>
                <option value="د.م." data-symbol="د.م." data-name="Dirhams">
                  Morocco (MAD)
                </option>
                <option value="د.ت" data-symbol="د.ت" data-name="Dinars">
                  Tunisia (TND)
                </option>
                <option value="د.ج" data-symbol="د.ج" data-name="Dinars">
                  Algeria (DZD)
                </option>
                <option value="Br" data-symbol="Br" data-name="Birr">
                  Ethiopia (ETB)
                </option>
                <option value="P" data-symbol="P" data-name="Pula">
                  Botswana (BWP)
                </option>
                <option value="K" data-symbol="K" data-name="Kwacha">
                  Zambia (ZMW)
                </option>
                <option value="Z$" data-symbol="Z$" data-name="Dollars">
                  Zimbabwe (ZWL)
                </option>
                <option value="Fr" data-symbol="Fr" data-name="Francs">
                  Rwanda (RWF)
                </option>
                <option value="Sh" data-symbol="Sh" data-name="Shillings">
                  Somalia (SOS)
                </option>
                <option value="E" data-symbol="E" data-name="Lilangeni">
                  Eswatini (SZL)
                </option>
                <option value="L" data-symbol="L" data-name="Loti">
                  Lesotho (LSL)
                </option>
                <option value="MT" data-symbol="MT" data-name="Meticals">
                  Mozambique (MZN)
                </option>
                <option value="Kz" data-symbol="Kz" data-name="Kwanza">
                  Angola (AOA)
                </option>
              </optgroup>
            </select>
          </div>

          <h3
            class="text-sm font-bold text-slate-500 uppercase border-b pb-1 mt-6"
          >
            Payment Details
          </h3>
          <input
            type="text"
            id="receivedFrom"
            placeholder="Received From (Name)"
            class="w-full p-3 border rounded-xl"
            oninput="update()"
          />
          <input
            type="number"
            id="amtFigure"
            placeholder="Amount Paid (Figure)"
            class="w-full p-3 border rounded-xl"
            oninput="update()"
          />
          <input
            type="number"
            id="balanceAmt"
            placeholder="Balance Owed (Optional)"
            class="w-full p-3 border rounded-xl"
            oninput="update()"
          />
          <input
            type="text"
            id="purpose"
            placeholder="Being payment for (e.g. 1 Plot of Land)"
            class="w-full p-3 border rounded-xl"
            oninput="update()"
          />

          <select
            id="method"
            class="w-full p-3 border rounded-xl"
            onchange="update()"
          >
            <option value="Cash">Cash</option>
            <option value="Cheque">Cheque</option>
            <option value="Card">Card</option>
            <option value="Momo">Momo</option>
          </select>

          <textarea
            id="note"
            placeholder="Note / Thank you message"
            class="w-full p-3 border rounded-xl h-16"
            oninput="update()"
          ></textarea>

          <h3
            class="text-sm font-bold text-slate-500 uppercase border-b pb-1 mt-6"
          >
            Signature
          </h3>
          <div class="space-y-2">
            <label class="text-sm font-bold text-slate-500">Sign Here</label>
            <div
              class="border-2 border-dashed border-slate-300 rounded-xl bg-slate-50 touch-none"
            >
              <canvas
                id="sigCanvas"
                class="w-full h-32 rounded-xl cursor-crosshair"
              ></canvas>
            </div>
            <button
              onclick="clearSignature()"
              class="text-xs text-red-500 font-bold hover:underline"
            >
              Clear Signature
            </button>
          </div>

          <h3
            class="text-sm font-bold text-slate-500 uppercase border-b pb-1 mt-6"
          >
            Colors
          </h3>
          <div class="flex flex-wrap gap-2">
            <button
              onclick="changeColor('#2563eb')"
              class="w-8 h-8 rounded-lg bg-blue-600 border-2 border-white shadow-md hover:scale-110 transition"
            ></button>
            <button
              onclick="changeColor('#0d9488')"
              class="w-8 h-8 rounded-lg bg-teal-600 border-2 border-white shadow-md hover:scale-110 transition"
            ></button>
            <button
              onclick="changeColor('#e11d48')"
              class="w-8 h-8 rounded-lg bg-rose-600 border-2 border-white shadow-md hover:scale-110 transition"
            ></button>
            <button
              onclick="changeColor('#ca8a04')"
              class="w-8 h-8 rounded-lg bg-yellow-600 border-2 border-white shadow-md hover:scale-110 transition"
            ></button>
            <button
              onclick="changeColor('#4f46e5')"
              class="w-8 h-8 rounded-lg bg-indigo-600 border-2 border-white shadow-md hover:scale-110 transition"
            ></button>
            <button
              onclick="changeColor('#18181b')"
              class="w-8 h-8 rounded-lg bg-zinc-900 border-2 border-white shadow-md hover:scale-110 transition"
            ></button>
            <button
              onclick="changeColor('#7c3aed')"
              class="w-8 h-8 rounded-lg bg-violet-600 border-2 border-white shadow-md hover:scale-110 transition"
            ></button>
            <button
              onclick="changeColor('#db2777')"
              class="w-8 h-8 rounded-lg bg-pink-600 border-2 border-white shadow-md hover:scale-110 transition"
            ></button>
            <button
              onclick="changeColor('#0891b2')"
              class="w-8 h-8 rounded-lg bg-cyan-600 border-2 border-white shadow-md hover:scale-110 transition"
            ></button>
            <button
              onclick="changeColor('#16a34a')"
              class="w-8 h-8 rounded-lg bg-green-600 border-2 border-white shadow-md hover:scale-110 transition"
            ></button>
            <button
              onclick="changeColor('#ea580c')"
              class="w-8 h-8 rounded-lg bg-orange-600 border-2 border-white shadow-md hover:scale-110 transition"
            ></button>
            <button
              onclick="changeColor('#dc2626')"
              class="w-8 h-8 rounded-lg bg-red-600 border-2 border-white shadow-md hover:scale-110 transition"
            ></button>
            <button
              onclick="changeColor('#eab308')"
              class="w-8 h-8 rounded-lg bg-yellow-400 border-2 border-white shadow-md hover:scale-110 transition"
            ></button>
            <button
              onclick="changeColor('#f59e0b')"
              class="w-8 h-8 rounded-lg bg-amber-500 border-2 border-white shadow-md hover:scale-110 transition"
            ></button>
            <button
              onclick="changeColor('#d97706')"
              class="w-8 h-8 rounded-lg bg-amber-600 border-2 border-white shadow-md hover:scale-110 transition"
            ></button>
          </div>

          <button
            onclick="downloadPDF()"
            class="w-full bg-blue-600 text-white font-bold py-4 rounded-xl hover:bg-blue-700 transition shadow-lg shadow-blue-200"
          >
            <i class="fa-solid fa-download mr-2"></i> DOWNLOAD RECEIPT
          </button>
        </div>
      </div>

      <div class="xl:col-span-8">
        <div id="previewScale">
          <div id="receiptCapture" class="formal-font">
            <div id="innerBorder">
              <div
                id="topBorder"
                class="flex justify-between items-start border-b-4 border-blue-600 pb-4 mb-6"
              >
                <div class="flex gap-4 items-center">
                  <img id="pLogo" src="" class="h-16 hidden" />
                  <div>
                    <h1
                      id="pBizName"
                      class="text-2xl font-black uppercase leading-tight"
                    >
                      Company Name
                    </h1>
                    <p
                      id="pBizInfo"
                      class="text-xs font-sans text-slate-500 whitespace-pre-line"
                    ></p>
                  </div>
                </div>
                <div class="text-right">
                  <h2
                    id="accentText"
                    class="text-3xl font-black text-blue-600 italic"
                  >
                    OFFICIAL RECEIPT
                  </h2>
                  <p class="font-sans text-sm mt-1">
                    NO:
                    <span id="pNo" class="font-bold border-b border-slate-400"
                      >---</span
                    >
                  </p>
                  <p class="font-sans text-sm">
                    Date:
                    <span id="pDate" class="border-b border-slate-400"
                      >---</span
                    >
                  </p>
                </div>
              </div>

              <div class="text-lg leading-[2.5] text-slate-700">
                Received from
                <span class="dotted-line min-w-[350px]" id="pRecFrom"></span>
                the sum of
                <span
                  class="dotted-line flex-1 min-w-[500px]"
                  id="pAmtWords"
                ></span>
                <br />
                being
                <span class="dotted-line min-w-[550px]" id="pPurpose"></span>
              </div>

              <div class="mt-8 flex justify-between items-end">
                <div class="space-y-4">
                  <div
                    class="border-2 border-slate-800 p-4 min-w-[240px] bg-slate-50"
                  >
                    <div class="text-sm font-sans font-bold uppercase mb-1">
                      Amount Paid
                    </div>
                    <!-- Changed to block and added padding to ensure text is visible in PDF -->
                    <div class="text-2xl font-black text-black" id="pAmtFig">
                      ---
                    </div>
                  </div>
                  <div class="text-sm font-sans">
                    <strong>Balance:</strong>
                    <span id="pBalance" class="border-b border-slate-400 px-4"
                      >---</span
                    >
                  </div>
                </div>

                <div class="text-center">
                  <p class="text-sm font-sans mb-1">
                    Payment Method:
                    <span id="pMethod" class="font-bold">---</span>
                  </p>
                  <div
                    class="w-48 border-b border-slate-800 mb-1 relative h-12 flex items-end justify-center"
                  >
                    <img
                      id="pSignature"
                      class="absolute bottom-0 h-16 object-contain hidden pointer-events-none"
                    />
                  </div>
                  <p class="text-xs uppercase font-sans font-bold">Signature</p>
                </div>
              </div>

              <div
                class="mt-8 pt-4 border-t border-slate-100 flex justify-between items-center"
              >
                <p id="pNote" class="text-sm italic text-slate-500">
                  Thank you for your business!
                </p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      function loadLogo(input) {
        if (input.files && input.files[0]) {
          const reader = new FileReader();
          reader.onload = (e) => {
            const img = document.getElementById("pLogo");
            img.src = e.target.result;
            img.classList.remove("hidden");
          };
          reader.readAsDataURL(input.files[0]);
        }
      }

      function changeColor(hex) {
        document.getElementById("accentText").style.color = hex;
        document.getElementById("topBorder").style.borderColor = hex;
      }

      // Enhanced Number to Words
      function numberToWords(n) {
        if (n < 0) return "Minus " + numberToWords(-n);
        if (n == 0) return "Zero";

        const a = [
          "",
          "one",
          "two",
          "three",
          "four",
          "five",
          "six",
          "seven",
          "eight",
          "nine",
          "ten",
          "eleven",
          "twelve",
          "thirteen",
          "fourteen",
          "fifteen",
          "sixteen",
          "seventeen",
          "eighteen",
          "nineteen",
        ];
        const b = [
          "",
          "",
          "twenty",
          "thirty",
          "forty",
          "fifty",
          "sixty",
          "seventy",
          "eighty",
          "ninety",
        ];
        const g = [
          "",
          "thousand",
          "million",
          "billion",
          "trillion",
          "quadrillion",
          "quintillion",
          "sextillion",
          "septillion",
          "octillion",
          "nonillion",
        ];

        function makeGroup(num) {
          let str = "";
          if (num >= 100) {
            str += a[Math.floor(num / 100)] + " hundred ";
            num %= 100;
          }
          if (num > 0) {
            if (num < 20) {
              str += a[num] + " ";
            } else {
              str += b[Math.floor(num / 10)] + " ";
              if (num % 10 > 0) str += a[num % 10] + " ";
            }
          }
          return str;
        }

        let word = "";
        let groupIndex = 0;

        if (n == 0) return "Zero";

        while (n > 0) {
          let remainder = n % 1000;
          if (remainder > 0) {
            let groupWord = makeGroup(remainder);
            word = groupWord + g[groupIndex] + " " + word;
          }
          n = Math.floor(n / 1000);
          groupIndex++;
        }
        return word.trim();
      }

      // Signature Logic
      const canvas = document.getElementById("sigCanvas");
      const ctx = canvas.getContext("2d");
      let isDrawing = false;

      function resizeCanvas() {
        // Set canvas resolution to match display size
        const rect = canvas.getBoundingClientRect();
        canvas.width = rect.width;
        canvas.height = rect.height;
        ctx.lineWidth = 2;
        ctx.lineCap = "round";
        ctx.strokeStyle = "#000";
      }

      // Resize initially and on resize
      window.addEventListener("resize", resizeCanvas);
      // Wait for layout
      setTimeout(resizeCanvas, 100);

      function startDraw(e) {
        isDrawing = true;
        draw(e);
      }

      function endDraw() {
        isDrawing = false;
        ctx.beginPath();
        updateSignaturePreview();
      }

      function draw(e) {
        if (!isDrawing) return;
        e.preventDefault(); // Stop scrolling on touch

        const rect = canvas.getBoundingClientRect();
        const clientX = e.clientX || e.touches[0].clientX;
        const clientY = e.clientY || e.touches[0].clientY;

        ctx.lineTo(clientX - rect.left, clientY - rect.top);
        ctx.stroke();
        ctx.beginPath();
        ctx.moveTo(clientX - rect.left, clientY - rect.top);
      }

      function clearSignature() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        updateSignaturePreview();
        document.getElementById("pSignature").classList.add("hidden");
      }

      function updateSignaturePreview() {
        const dataUrl = canvas.toDataURL();
        // Check if canvas is empty by simple pixel check or just update
        // A simple way to check emptiness is complex, so we'll just update for now.
        // If cleared, it's transparent.
        const pSig = document.getElementById("pSignature");
        pSig.src = dataUrl;
        pSig.classList.remove("hidden");
      }

      // Events
      canvas.addEventListener("mousedown", startDraw);
      canvas.addEventListener("mouseup", endDraw);
      canvas.addEventListener("mousemove", draw);

      canvas.addEventListener("touchstart", startDraw);
      canvas.addEventListener("touchend", endDraw);
      canvas.addEventListener("touchmove", draw);

      function update() {
        const select = document.getElementById("currency");
        const sym =
          select.options[select.selectedIndex].getAttribute("data-symbol");
        const currencyName =
          select.options[select.selectedIndex].getAttribute("data-name");

        const amt = parseFloat(document.getElementById("amtFigure").value) || 0;
        const bal = document.getElementById("balanceAmt").value;

        document.getElementById("pBizName").innerText =
          document.getElementById("bizName").value || "YOUR COMPANY NAME";
        document.getElementById("pBizInfo").innerText =
          document.getElementById("bizInfo").value;
        document.getElementById("pNo").innerText =
          document.getElementById("rNo").value || "---";

        // Date Logic
        const dateInput = document.getElementById("rDate").value;
        const displayDate = dateInput
          ? new Date(dateInput).toLocaleDateString()
          : new Date().toLocaleDateString();
        document.getElementById("pDate").innerText = displayDate;

        document.getElementById("pRecFrom").innerText =
          document.getElementById("receivedFrom").value;
        document.getElementById("pPurpose").innerText =
          document.getElementById("purpose").value;
        document.getElementById("pMethod").innerText =
          document.getElementById("method").value;
        document.getElementById("pNote").innerText =
          document.getElementById("note").value || "Thank you!";

        document.getElementById("pAmtFig").innerText =
          `${sym} ${amt.toLocaleString()}`;

        let words = numberToWords(Math.floor(amt));
        document.getElementById("pAmtWords").innerText =
          words.toUpperCase() +
          " " +
          (currencyName ? currencyName.toUpperCase() : "DOLLARS") +
          " ONLY";

        document.getElementById("pBalance").innerText = bal
          ? `${sym} ${parseFloat(bal).toLocaleString()}`
          : "---";
      }

      function downloadPDF() {
        const element = document.getElementById("receiptCapture");
        const opt = {
          margin: 5,
          filename: "Official_Receipt.pdf",
          image: { type: "jpeg", quality: 1 },
          html2canvas: { scale: 3 },
          jsPDF: { unit: "mm", format: "a4", orientation: "landscape" },
        };
        html2pdf().set(opt).from(element).save();
      }

      // Init
      update();
    </script>
  </body>
</html>
