<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>One-Page Receipt Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
      @import url("https://fonts.googleapis.com/css2?family=Inter:wght@400;700&family=Courier+Prime&display=swap");

      body {
        font-family: "Inter", sans-serif;
      }

      .receipt-font {
        font-family: "Courier Prime", monospace;
      }

      /* Preview Container */
      .preview-area {
        background: #cbd5e1;
        padding: 40px 20px;
        display: flex;
        justify-content: center;
        align-items: flex-start;
        min-height: 100vh;
      }

      /* Fixed Receipt Style */
      #receiptCard {
        width: 380px;
        background: white;
        padding: 25px;
        box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.1);
        position: relative;
        /* Prevents splitting in PDF */
        page-break-inside: avoid;
      }

      /* Zig Zag Bottom */
      .zig-zag {
        position: absolute;
        bottom: -10px;
        left: 0;
        width: 100%;
        height: 10px;
        background:
          linear-gradient(-45deg, transparent 5px, white 5px),
          linear-gradient(45deg, transparent 5px, white 5px);
        background-size: 10px 10px;
      }
    </style>
    <!-- Firebase Auth Protection -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="trial.js"></script>
    <script>
      const firebaseConfig = {
        apiKey: "AIzaSyDnN7AODVubqLmnOniyjQkSWGvBJJ2kMQU",
        authDomain: "invoiceapp-3fe51.firebaseapp.com",
        projectId: "invoiceapp-3fe51",
        storageBucket: "invoiceapp-3fe51.firebasestorage.app",
        messagingSenderId: "178955208220",
        appId: "1:178955208220:web:128a713add6c992f9981d9",
      };
      if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
      const auth = firebase.auth();
      const db = firebase.firestore();
      auth.onAuthStateChanged(async (user) => {
        if (!user) window.location.href = "login.html";
        else {
          const userDoc = await db.collection("users").doc(user.uid).get();
          if (userDoc.exists) {
            const data = userDoc.data();
            const now = new Date();
            if (
              !data.subscriptionExpiry ||
              data.subscriptionExpiry.toDate() < now
            ) {
              if (window.blockPageWithSubscribe)
                window.blockPageWithSubscribe();
              else window.location.href = "payment.html";
            }
          } else {
            if (window.blockPageWithSubscribe) window.blockPageWithSubscribe();
            else window.location.href = "payment.html";
          }
        }
      });
    </script>
  </head>

  <body class="bg-slate-50">
    <div class="max-w-7xl mx-auto px-4 py-2">
      <a
        href="dashboard.html"
        class="inline-flex items-center gap-2 text-slate-600 hover:text-blue-600 font-bold transition text-sm"
      >
        <i class="fa-solid fa-arrow-left"></i> Back to Dashboard
      </a>
    </div>
    <div class="max-w-7xl mx-auto grid grid-cols-1 lg:grid-cols-12 gap-0">
      <div
        class="lg:col-span-5 p-6 lg:p-10 bg-white border-r border-slate-200 space-y-8"
      >
        <div>
          <h1 class="text-2xl font-black text-slate-800">
            Receipt<span class="text-emerald-500">Fast</span>
          </h1>
          <p class="text-sm text-slate-500">
            Generate professional one-page receipts.
          </p>
        </div>

        <div class="space-y-4">
          <input
            type="file"
            accept="image/*"
            onchange="handleLogo(this)"
            class="block w-full text-xs text-slate-500 border p-2 rounded-lg"
          />
          <input
            type="text"
            id="bizName"
            placeholder="Business Name"
            class="w-full p-3 border rounded-xl"
            oninput="update()"
          />

          <div class="grid grid-cols-2 gap-3">
            <input
              type="text"
              id="rNo"
              placeholder="Receipt No #001"
              class="p-3 border rounded-xl"
              oninput="update()"
            />
            <select
              id="currency"
              class="p-3 border rounded-xl bg-slate-50"
              onchange="update()"
            >
              <option value="$" data-symbol="$">USA (USD)</option>
              <option value="$" data-symbol="$">Canada (CAD)</option>
              <option value="£" data-symbol="£">UK (GBP)</option>
              <option value="€" data-symbol="€">Europe (EUR)</option>
              <option value="₣" data-symbol="₣">Switzerland (CHF)</option>
              <option value="A$" data-symbol="A$">Australia (AUD)</option>
              <option value="¥" data-symbol="¥">Japan (JPY)</option>
              <option value="¥" data-symbol="¥">China (CNY)</option>
              <option value="₹" data-symbol="₹">India (INR)</option>
              <option value="S$" data-symbol="S$">Singapore (SGD)</option>
              <option value="HK$" data-symbol="HK$">Hong Kong (HKD)</option>
              <option value="$" data-symbol="$">Mexico (MXN)</option>
              <option value="R$" data-symbol="R$">Brazil (BRL)</option>
              <option value="₨" data-symbol="₨">Pakistan (PKR)</option>
              <option value="د.إ" data-symbol="د.إ">UAE (AED)</option>
              <option value="฿" data-symbol="฿">Thailand (THB)</option>
              <optgroup label="African Countries">
                <option value="E£" data-symbol="E£">Egypt (EGP)</option>
                <option value="GH₵" data-symbol="GH₵">Ghana (GHS)</option>
                <option value="₦" data-symbol="₦">Nigeria (NGN)</option>
                <option value="R" data-symbol="R">South Africa (ZAR)</option>
                <option value="Sh" data-symbol="Sh">Kenya (KES)</option>
                <option value="Sh" data-symbol="Sh">Tanzania (TZS)</option>
                <option value="Sh" data-symbol="Sh">Uganda (UGX)</option>
                <option value="د.م." data-symbol="د.م.">Morocco (MAD)</option>
                <option value="د.ت" data-symbol="د.ت">Tunisia (TND)</option>
                <option value="د.ج" data-symbol="د.ج">Algeria (DZD)</option>
                <option value="Br" data-symbol="Br">Ethiopia (ETB)</option>
                <option value="P" data-symbol="P">Botswana (BWP)</option>
                <option value="K" data-symbol="K">Zambia (ZMW)</option>
                <option value="Z$" data-symbol="Z$">Zimbabwe (ZWL)</option>
                <option value="Fr" data-symbol="Fr">Rwanda (RWF)</option>
                <option value="Sh" data-symbol="Sh">Somalia (SOS)</option>
                <option value="E" data-symbol="E">Eswatini (SZL)</option>
                <option value="L" data-symbol="L">Lesotho (LSL)</option>
                <option value="MT" data-symbol="MT">Mozambique (MZN)</option>
                <option value="Kz" data-symbol="Kz">Angola (AOA)</option>
              </optgroup>
            </select>
          </div>

          <input
            type="text"
            id="cust"
            placeholder="Customer Name"
            class="w-full p-3 border rounded-xl"
            oninput="update()"
          />

          <select
            id="method"
            class="w-full p-3 border rounded-xl"
            onchange="update()"
          >
            <option value="CASH">CASH</option>
            <option value="BANK TRANSFER">BANK TRANSFER</option>
            <option value="CARD">DEBIT/CREDIT CARD</option>
            <option value="MOBILE MONEY">MOBILE MONEY</option>
          </select>

          <input
            type="date"
            id="rDate"
            class="w-full p-3 border rounded-xl text-slate-500"
            oninput="update()"
          />

          <div class="flex flex-wrap gap-2 py-2">
            <button
              onclick="changeColor('#2563eb')"
              class="w-8 h-8 rounded-full bg-blue-600 border-2 border-white shadow-md"
            ></button>
            <button
              onclick="changeColor('#0d9488')"
              class="w-8 h-8 rounded-full bg-teal-600 border-2 border-white shadow-md"
            ></button>
            <button
              onclick="changeColor('#e11d48')"
              class="w-8 h-8 rounded-full bg-rose-600 border-2 border-white shadow-md"
            ></button>
            <button
              onclick="changeColor('#ca8a04')"
              class="w-8 h-8 rounded-full bg-yellow-600 border-2 border-white shadow-md"
            ></button>
            <button
              onclick="changeColor('#4f46e5')"
              class="w-8 h-8 rounded-full bg-indigo-600 border-2 border-white shadow-md"
            ></button>
            <button
              onclick="changeColor('#18181b')"
              class="w-8 h-8 rounded-full bg-zinc-900 border-2 border-white shadow-md"
            ></button>
            <button
              onclick="changeColor('#7c3aed')"
              class="w-8 h-8 rounded-full bg-violet-600 border-2 border-white shadow-md"
            ></button>
            <button
              onclick="changeColor('#db2777')"
              class="w-8 h-8 rounded-full bg-pink-600 border-2 border-white shadow-md"
            ></button>
            <button
              onclick="changeColor('#0891b2')"
              class="w-8 h-8 rounded-full bg-cyan-600 border-2 border-white shadow-md"
            ></button>
            <button
              onclick="changeColor('#16a34a')"
              class="w-8 h-8 rounded-full bg-green-600 border-2 border-white shadow-md"
            ></button>
            <button
              onclick="changeColor('#ea580c')"
              class="w-8 h-8 rounded-full bg-orange-600 border-2 border-white shadow-md"
            ></button>
            <button
              onclick="changeColor('#dc2626')"
              class="w-8 h-8 rounded-full bg-red-600 border-2 border-white shadow-md"
            ></button>
            <button
              onclick="changeColor('#eab308')"
              class="w-8 h-8 rounded-full bg-yellow-400 border-2 border-white shadow-md"
            ></button>
            <button
              onclick="changeColor('#f59e0b')"
              class="w-8 h-8 rounded-full bg-amber-500 border-2 border-white shadow-md"
            ></button>
            <button
              onclick="changeColor('#d97706')"
              class="w-8 h-8 rounded-full bg-amber-600 border-2 border-white shadow-md"
            ></button>
          </div>

          <div id="itemsList" class="space-y-2"></div>
          <button
            onclick="addItem()"
            class="text-sm font-bold text-emerald-600 hover:underline"
          >
            + Add Item
          </button>

          <div class="grid grid-cols-2 gap-3 pt-4">
            <input
              type="number"
              id="disc"
              placeholder="Discount %"
              class="p-3 border rounded-xl"
              oninput="update()"
            />
            <input
              type="text"
              id="note"
              placeholder="Note: Thank you!"
              class="p-3 border rounded-xl"
              oninput="update()"
            />
          </div>
        </div>

        <button
          onclick="download()"
          class="w-full bg-slate-900 text-white font-bold py-4 rounded-xl flex items-center justify-center gap-2 hover:bg-black transition"
        >
          <i class="fa-solid fa-file-pdf"></i> Download Receipt
        </button>
      </div>

      <div class="lg:col-span-7 preview-area">
        <div id="receiptCard" class="receipt-font">
          <div class="text-center mb-6">
            <img
              id="pLogo"
              src=""
              class="h-12 mx-auto mb-2 hidden object-contain"
            />
            <h2 id="pBizName" class="text-xl font-bold uppercase">
              Business Name
            </h2>
            <div
              class="w-full border-b border-double border-slate-300 my-2"
            ></div>
            <p
              class="text-[10px] tracking-[0.2em] text-slate-400 font-sans uppercase"
            >
              Transaction Receipt
            </p>
          </div>

          <div class="text-xs space-y-1 mb-6">
            <div class="flex justify-between">
              <span>No:</span><span id="pNo" class="font-bold">#---</span>
            </div>
            <div class="flex justify-between">
              <span>Date:</span><span id="pDate">---</span>
            </div>
            <div class="flex justify-between">
              <span>Customer:</span
              ><span id="pCust" class="font-bold">Walk-in</span>
            </div>
          </div>

          <div class="text-sm mb-4 border-t border-b border-black py-2">
            <div class="flex justify-between font-bold mb-2">
              <span>Item</span>
              <span>Price</span>
            </div>
            <div id="pItems" class="space-y-1"></div>
          </div>

          <div class="text-sm space-y-1 mb-6">
            <div class="flex justify-between">
              <span>Subtotal:</span><span id="pSub">0.00</span>
            </div>
            <div class="flex justify-between text-slate-400">
              <span>Discount:</span><span id="pDisc">0.00</span>
            </div>
            <div
              id="accentText"
              class="flex justify-between text-xl font-bold text-emerald-600 pt-2"
            >
              <span>TOTAL:</span><span id="pTotal">0.00</span>
            </div>
          </div>

          <div class="text-center space-y-4">
            <div class="text-[10px] bg-slate-100 py-1 font-sans rounded">
              PAID VIA: <span id="pMethod">CASH</span>
            </div>
            <p id="pNote" class="text-xs italic text-slate-500">
              Thank you for your business!
            </p>
            <div class="pt-4 flex flex-col items-center opacity-20">
              <i class="fa-solid fa-barcode text-5xl"></i>
              <span class="text-[8px] tracking-[0.5em] mt-1"
                >VERIFIED TRANSACTION</span
              >
            </div>
          </div>

          <div class="zig-zag"></div>
        </div>
      </div>
    </div>

    <script>
      function handleLogo(input) {
        if (input.files && input.files[0]) {
          const reader = new FileReader();
          reader.onload = (e) => {
            const img = document.getElementById("pLogo");
            img.src = e.target.result;
            img.classList.remove("hidden");
          };
          reader.readAsDataURL(input.files[0]);
        }
      }

      function changeColor(hex) {
        document.getElementById("accentText").style.color = hex;
      }

      function addItem() {
        const id = Date.now();
        const html = `
                <div id="item-${id}" class="flex gap-2">
                    <input type="text" placeholder="Item" class="flex-1 p-2 bg-slate-50 rounded text-sm item-name" oninput="update()">
                    <input type="number" placeholder="Price" class="w-20 p-2 bg-slate-50 rounded text-sm text-right item-price" oninput="update()">
                    <button onclick="document.getElementById('item-${id}').remove(); update();" class="text-rose-400 text-xs"><i class="fa-solid fa-trash"></i></button>
                </div>
            `;
        document
          .getElementById("itemsList")
          .insertAdjacentHTML("beforeend", html);
      }

      function update() {
        const select = document.getElementById("currency");
        const sym =
          select.options[select.selectedIndex].getAttribute("data-symbol");
        document.getElementById("pBizName").innerText =
          document.getElementById("bizName").value || "Business Name";
        document.getElementById("pNo").innerText =
          document.getElementById("rNo").value || "#000";
        const dateInput = document.getElementById("rDate").value;
        let displayDate;
        if (dateInput) {
          const d = new Date(dateInput);
          displayDate = d.toLocaleDateString();
        } else {
          displayDate = new Date().toLocaleDateString();
        }
        document.getElementById("pDate").innerText = displayDate;
        document.getElementById("pCust").innerText =
          document.getElementById("cust").value || "Walk-in Customer";
        document.getElementById("pMethod").innerText =
          document.getElementById("method").value;
        document.getElementById("pNote").innerText =
          document.getElementById("note").value ||
          "Thank you for your business!";

        let sub = 0;
        let listHtml = "";
        document.querySelectorAll("#itemsList > div").forEach((div) => {
          const name = div.querySelector(".item-name").value || "General Item";
          const price = parseFloat(div.querySelector(".item-price").value) || 0;
          sub += price;
          listHtml += `<div class="flex justify-between"><span>${name}</span><span>${sym}${price.toFixed(2)}</span></div>`;
        });

        const dPercent = parseFloat(document.getElementById("disc").value) || 0;
        const dVal = sub * (dPercent / 100);

        document.getElementById("pItems").innerHTML = listHtml;
        document.getElementById("pSub").innerText = `${sym}${sub.toFixed(2)}`;
        document.getElementById("pDisc").innerText =
          `-${sym}${dVal.toFixed(2)}`;
        document.getElementById("pTotal").innerText =
          `${sym}${(sub - dVal).toFixed(2)}`;
      }

      function download() {
        const element = document.getElementById("receiptCard");
        // Hide the box shadow for the PDF
        element.style.boxShadow = "none";

        const opt = {
          margin: 0,
          filename: `Receipt_${document.getElementById("rNo").value || "001"}.pdf`,
          image: { type: "jpeg", quality: 1 },
          html2canvas: { scale: 3, useCORS: true },
          jsPDF: { unit: "mm", format: [100, 180], orientation: "portrait" },
        };

        html2pdf()
          .set(opt)
          .from(element)
          .save()
          .then(() => {
            element.style.boxShadow = "0 20px 25px -5px rgb(0 0 0 / 0.1)";
          });
      }

      addItem(); // Add first item on load
    </script>
  </body>
</html>
